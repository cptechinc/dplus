<?php namespace ProcessWire;
// Purl
use Purl\Url;
// Dplus Filters
use Dplus\Filters\Mso\Cxm   as CxmFilter;
use Dplus\Filters\Map\Mxrfe as MxrfeFilter;
use Dplus\Filters\Map\Vxm   as VxmFilter;
use Dplus\Filters\Min\Upcx  as UpcxFilter;

/**
 * Module that handles the editing of the ITM item X-refs
 */
class ItmXrefs extends WireData implements Module {
	const MODEL              = 'ItemMasterItem';
	const MODEL_KEY          = 'code';
	const DESCRIPTION        = 'ITM Item';
	const DESCRIPTION_RECORD = 'ITM Item';

	public function __construct() {
		$this->description = self::DESCRIPTION;
		$this->xrefs = new WireData();
		$this->xrefs->upcx = false;
		$this->xrefs->cxm = false;
	}

	public function init2() {
		$this->xrefs->cxm = $modules->get('XrefCxm');
	}

/* =============================================================
	CRUD Proccessing Functions
============================================================= */
	/**
	 * Takes Input, validates it's for one of the code tables
	 * Processes it, and if updated sends request to dplus
	 *
	 * @param  WireInput $input Input
	 * @return void
	 */
	public function process_input(WireInput $input) {
		$itm = $this->wire('modules')->get('Itm');
		$rm = strtolower($input->requestMethod());
		$values = $input->$rm;
		$itemID = $values->text('itemID');

		if ($values->action) {
			if ($itm->item_exists($itemID)) {
				if ($values->text('action') == 'update-itm-xrefs') {
					$response = $this->process_input_xref($input);
				}
			} else {
				$response = ItmResponse::response_error($itemID, "Item $itemID does not exist");
			}
		} else {
			$response = ItmResponse::response_error($itemID, "No Action was specified");
		}
		$this->wire('session')->setFor('response', 'itm', $response);
	}

	/**
	 * Takes Input, validates it's for an Item
	 * Updates Item
	 * Processes it, and if updated sends request to dplus
	 *
	 * @param  WireInput $input Input
	 * @return void
	 */
	public function process_input_xref(WireInput $input) {
		$itm = $this('modules')->get('Itm');
		$rm = strtolower($input->requestMethod());
		$values = $input->$rm;
		$itemID = strtoupper($values->text('itemID'));
		$record = $itm->get_item($itemID);

		if ($record->isNew() === false) {
			$itm->lockrecord($itemID);
		}

		if ($record->isNew() || $itm->recordlocker->function_locked_by_user($itemID)) {
			if ($values->text('action') == 'update-itm-xrefs') {
				$record->setSupercededby(strtoupper($values->text('supercededby')));

				if (strlen($values->text('supercededby'))) {
					if ($itm->item_exists($values->text('supercededby'))) {
						$response_itm = $itm->save_and_respond($record);
					} else {
						$response_itm = ItmResponse::response_error($record->itemid, "Supercede Item $record->supercededby does not exist");
					}
				}

				$this->send_cxm_update($input);
			} else {
				$message = self::DESCRIPTION_RECORD . " ($record->itemid) was not saved, no action was specified";
				$response_itm = ItmResponse::response_error($record->itemid, $message);
			}
		} else {
			$message = self::DESCRIPTION_RECORD . " ($record->itemid)  was not saved, it is locked by " . $itm->recordlocker->get_locked_user($itemID);
			$response_itm = ItmResponse::response_error($record->itemid, $message);
		}
		return $response_itm;
	}

/* =============================================================
	Request Functions
============================================================= */
	/**
	 * Send Request to Update the Short Item ID using the XrefCxm module
	 * @param  WireInput $input
	 * @return void
	 */
	protected function send_cxm_update(WireInput $input)  {
		$cxm = $this('modules')->get('XrefCxm');
		$rm = strtolower($input->requestMethod());
		$values = $input->$rm;
		$itemID = strtoupper($values->text('itemID'));

		if (!$cxm->xref_shortitem_exists($itemID) || $cxm->xref_shortitem($itemID)->custitemid != $values->text('cxm_custitemid')) {
			$data = array('action' => 'update-cxm-shortitem', 'itemID' => $itemID, 'custitemid' => $values->text('cxm_custitemid'));
			$input_cxm = new WireInput();
			$input_cxm->$rm->setArray($data);
			$cxm->process_input($input_cxm);
		}
	}

/* =============================================================
	ProcessWire Module Functions
============================================================= */
	public static function getModuleInfo() {
		return array(
			'title' => 'Dplus ITM XRefs CRUD Manager',
			'version' => 101,
			'summary' => 'Module for CRUD Methods for ITM Xrefs',
			'singular' => true,
			'autoload' => true,
		);
	}
}
