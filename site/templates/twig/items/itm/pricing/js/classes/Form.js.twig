class PricingForm {
	static instance = null;

	static getInstance() {
		if (this.instance === null) {
			this.instance = new PricingForm();
		}
		return this.instance;
	}

	constructor() {
		this.id = 'itm-pricing-form';
		this.form = $('#' + this.id);
		this.inputs = PricingInputs.getInstance();
		this.config = PricingConfigs.getInstance();
	}

	updateUnitRow(unitrow) {
		var unitRow = UnitRow.fromHtml(unitrow);
		this.updatePricePrecision(unitRow);
		this.updateMargin(unitRow);
		this.updateUnitRowReadonly(unitRow);
	}

	updatePricePrecision(unitRow) {
		var price = parseFloat(unitRow.inputs.price.val());
		if (price > 0) {
			unitRow.inputs.price.val(price.toFixed(this.config.fields.price.precision));
		} else {
			unitRow.inputs.price.val('');
		}
	}

	updateMargin(unitRow) {
		if (parseFloat(unitRow.inputs.price.val()) > 0) {
			var calculator = PricingCalculator.getInstance();
			var margin = calculator.margin(unitRow.inputs.price.val(), this.inputs.uom.find('option:selected').data('conversion'), this.inputs.standardcost.val())
			unitRow.inputs.margin.text(margin.toFixed(this.config.fields.margin.precision));
		} else {
			unitRow.inputs.margin.text('');
		}
	}

	updateUnitRows() {
		var form = this;
		$(".unit-row").each(function(index) {
			form.updateUnitRow($(this));
		});
	}

	updateUnitRowReadonly(unitRow) {
		console.log(unitRow);
		var qty = parseFloat(unitRow.inputs.qty.val());

		if (qty == 0) {
			unitRow.inputs.price.val('');
			unitRow.inputs.price.attr('readonly', 'true');
			unitRow.updateInputsFromNextRow();
			if (unitRow.hasNextRow()) {
				var nextRow = unitRow.getNextRow();
				// nextRow.clearInputs();
				this.updateUnitRowReadonly(nextRow);
				this.updateNextUnitRow(unitRow);
			}
			return true;
		}

		unitRow.inputs.price.removeAttr('readonly');
		this.updateNextUnitRow(unitRow);
	}

	updateNextUnitRow(unitRow) {
		var nextRow = UnitRow.fromStep(parseInt(unitRow.row.data('step')) + 1);

		if (nextRow.row.length) {
			if (parseFloat(unitRow.inputs.qty.val()) > 0) {
				nextRow.inputs.qty.removeAttr('readonly');
			} else {
				nextRow.inputs.qty.attr('readonly', 'true');
			}
		}
	}
}
