$(function () {
	var form_intv  = $('#intv-form');
	var modal_intv = $('#notes-internal-modal');

	modal_intv.on('shown.bs.modal', function (e) {
		var modal = $(this);
		var button = $(e.relatedTarget);
		var note_row = button.closest('.qnote-row');

		if (note_row.length) {
			modal.find('.action-desc').text('Editing');
			modal.find('input[name=notedate]').val(button.data('date')).attr('readonly', '');
			modal.find('input[name=notetime]').val(button.data('time')).attr('readonly', '');
			modal.find('input[name=rawnotetime]').val(button.data('rawnotetime'));
			modal.find('textarea[name=note]').val(note_row.find('textarea').text());
		} else {
			modal.find('.action-desc').text('Adding');
			modal.find('input[name=rawnotetime]').val('');
			modal.find('textarea[name=note]').val('');

			$.getJSON('{{ page.jsonApiUrl('misc/date-time/') }}', function(datetime) {
				modal.find('input[name=notetime]').val(datetime.time).removeAttr('readonly');
				modal.find('input[name=notedate]').val(datetime.date).removeAttr('readonly');
			});
		}
	});

/* =============================================================
	Validation Functions
============================================================= */
	var validator = form_intv.validate({
		errorClass: "is-invalid",
		validClass: "is-valid",
		ignore: ".validate-ignore",
		errorPlacement: function(error, element) {
			error.insertAfter(element).addClass('invalid-feedback');
		},
		rules: {
			intv_note_date: {
				required: true,
			},
			intv_notetime: {
				required: true,
			},
		},
		messages: {
		},
		submitHandler: function(form) {
			var values = $(form).formValues();
			$('<input type="hidden" name="action" value="'+values.action+'">').appendTo($(form));

			if (values.action == 'delete-notes') {
				swal_delete_notes(function(confirmed) {
					if (confirmed) {
						form.submit();
					}
				});
			} else {
				form.submit();
			}
		}
	});
});
