$(function() {
	var editmodal = $('#edit-item-modal');
	var editform  = $('#edit-item-form');

/* =============================================================
	Edit Item Modal Functions
============================================================= */
	editmodal.on('show.bs.modal', function (event) {
		var modal = $(this);
		var button = $(event.relatedTarget);
		var linenbr = intParse(button.data('linenbr'));

		modal.find('.modal-title').find('input[name=linenbr]').val(linenbr);
		modal.find('.modal-title').find('.linenbr').text(linenbr);
		modal.find('[role=status]').addClass('spinner-border');
		modal.find('.loading').addClass('show');
		var url = URI('{{ page.fullURL.getUrl() }}');
		url.path(url.path() + 'line/');
		url.setQuery('linenbr', linenbr);

		modal.find('.modal-body .results').loadin(url.toString(), function() {
			modal.find('[role=status]').removeClass('spinner-border');
			modal.find('.loading').removeClass('show');
			setup_validation();
		});
	});

	$('body').on('click', '#edit-item-modal .whse-link', function(e) {
		e.preventDefault();
		var button = $(this);
		var modal = $(button.closest('.modal'));
		modal.find('input[name=whseid]').val(button.data('whseid'));
	});

/* =============================================================
	Validation Functions
============================================================= */
	function setup_validation() {
		$('#edit-item-form').validate({
			errorClass: "is-invalid",
			validClass: "is-valid",
			errorPlacement: function(error, element) {
				error.insertAfter(element).addClass('invalid-feedback');
			},
			rules: {
				price: {required: true},
				qty: {required: true},
				whseid: {
					required: true,
					remote: {
						url: '{{ page.jsonapiURL('inv/validate/warehouse/') }}',
						type: "get",
						data: {
							whseID: function() {
								return $('#editwhse').val();
							}
						}
					}
				},
			},
			messages: {},
			submitHandler: function(form) {
				form.submit();
			}
		});
	}
/* =============================================================
	Lookup Modal Functions
============================================================= */
	$("body").on('click', '#ajax-modal .whse-link', function(e) {
		e.preventDefault();
		var button = $(this);
		var modal = button.closest('.modal');
		var input = $(modal.attr('data-input'));
		input.val(button.data('whseid'));
		$('#ajax-modal').modal('hide');
	});
});
