class CodeForm {
	static instance = null;

	static getInstance() {
		if (this.instance === null) {
			this.instance = new CodeForm();
		}
		return this.instance;
	}

	constructor() {
		this.id = 'code-form';
		this.form = $('#' + this.id);
		this.inputs = CodeInputs.getInstance();
		this.config = CodeConfigs.getInstance();
	}

	updateInputsFromJson(json = null) {
		this.updateDeleteLink(json);

		if (json) {
			this.inputs.form.attr('data-code', json.code);
			this.inputs.code.val(json.code);
			this.inputs.code.attr('readonly', 'true');
			this.inputs.description.val(json.description);

			Object.getOwnPropertyNames(json).forEach((name, idx, array) => {
				if (this.inputs.hasOwnProperty(name)) {
					this.inputs[name].val(json[name]);
				}
			});
			this.enableDisableUseroute();
			this.triggerInputsChange();
			var validator = this.inputs.form.validate();
			validator.element('#' + this.inputs.code.attr('id'));
			return true;
		}
		this.clearInputs();
		var inputNamesSetToDefaultValues = [
			'billing', 'residential', 'airshipment', 
			'commercialflight', 'chargefreight', 'useroute', 'addsurcharge'
		];

		inputNamesSetToDefaultValues.forEach((name, idx, array) => {
			if (this.inputs.hasOwnProperty(name)) {
				this.inputs[name].val(this.config.fields[name].default);
			}
		});
		this.enableDisableUseroute();
		this.triggerInputsChange();
	}

	enableDisableUseroute() {
		var input = this.inputs.useroute;

		if (this.config.fields.useroute.enabled === false) {
			this.enableDisableInputs([input], false);
			this.setDisabled(input, true);
			return true;
		}
		this.enableDisableInputs([input], true);
		this.setDisabled(input, false);
	}

	clearInputs() {
		this.inputs.code.val('');
		this.inputs.form.attr('data-code', '');
		this.inputs.code.removeAttr('readonly');
		var inputNames = Object.getOwnPropertyNames(this.inputs);
		inputNames = inputNames.filter(function(item) {
			return item != 'id' && item != 'form';
		});
		inputNames.forEach((name, idx, array) => {
			if (this.inputs.hasOwnProperty(name)) {
				this.inputs[name].val('');
			}
		});
	}

	triggerInputsChange() {
		this.inputs.addsurcharge.change();
		this.inputs.surchargepercent.change();
		// this.inputs.artaxcode.change();
	}

	updateDeleteLink(json = null) {
		var button = this.form.find('a.delete_button');
		if (button.length == 0) {
			return false;
		}
		var uri = URI(button.attr('href'));
		var data = uri.query(true);

		if (json) {
			data.code = json.code;
			uri.query(data);
			button.attr('href', uri.toString());
			button.addClass('show');
			return true;
		}
		data.code = '';
		uri.query(data);
		button.attr('href', uri.toString());
		button.removeClass('show');
		return true;
	}

	/**
	 * Enable tabindex attribute on input
	 * @param	{Object} input 
	 * @returns {bool}
	 */
	enableTabindex(input) {
		if (input.attr('name') == undefined || input.attr('name') == '') {
			return false;
		}
		let tabindex = isNaN(input.attr('tabindex')) ? '' : Math.abs(parseInt(input.attr('tabindex')));
		input.attr('tabindex', tabindex);
	}

	/**
	 * Disable tabindex attribute on input
	 * @param	{Object} input 
	 * @returns {bool}
	 */
	disableTabindex(input) {
		if (input.attr('name') == undefined || input.attr('name') == '') {
			return false;
		}
		let disablePrefix = '-';

		let tabindex = isNaN(input.attr('tabindex')) ? '' : Math.abs(parseInt(input.attr('tabindex')));

		if (tabindex == '') {
			tabindex = 1;
		}
		input.attr('tabindex', disablePrefix + tabindex);
	}

	/**
	 * Set / remove Readonly attribute on input
	 * @param	{Object} input 
	 * @param	{bool}	 readonly 
	 * @returns {bool}
	 */
	setReadonly(input, readonly = true) {
		if (input.attr('name') == undefined || input.attr('name') == '') {
			return false;
		}
		if (readonly === false) {
			input.removeAttr('readonly');
			return true;
		}
		input.attr('readonly', 'readonly');
	}

	/**
	 * Enable / Disable multiple Inputs
	 * @param	{array} inputs 
	 * @param	{bool}	enable 
	 * @returns {bool}
	 */
	enableDisableInputs(inputs, enable = true) {
		let formTrm = this;

		if (enable === false) {
			inputs.forEach(input => {
				formTrm.setReadonly(input, true);
				formTrm.disableTabindex(input);
			});
			return true;
		}
		
		inputs.forEach(input => {
			formTrm.setReadonly(input, false);
			formTrm.enableTabindex(input);
		});
		return true;
	}

	/**
	 * Set / remove disabled attribute on input
	 * @param	{Object} input 
	 * @param	{bool}	 disable
	 * @returns {bool}
	 */
	setDisabled(input, disable = true) {
		if (input.attr('name') == undefined || input.attr('name') == '') {
			return false;
		}
		if (disable === false) {
			input.removeAttr('disabled');
			return true;
		}
		input.attr('disabled', 'disabled');
	}
}
