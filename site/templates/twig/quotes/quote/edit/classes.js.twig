function HeaderForm() {
	this.form = $('#edit-quote-form');
	this.fields = {
		custid: this.form.find('input[name=custID]'),
		shiptoid: this.form.find('input[name=shiptoID]'),
		shipto: {
			name: this.form.find('input[name=shipto_name]'),
			address1: this.form.find('input[name=shipto_address]'),
			address2: this.form.find('input[name=shipto_address2]'),
			city: this.form.find('input[name=shipto_city]'),
			state: this.form.find('input[name=shipto_state]'),
			zip: this.form.find('input[name=shipto_zip]'),
		}
	}
}

function AddItemForm() {
	this.form = $('#add-item-form'),
	this.fields = {
		itemid: this.form.find('input[name=itemID]'),
		qty: this.form.find('input[name=qty]'),
	},
	this.validateGetItem = function() {
		var server = new EqoRequests();
		var headerForm = new HeaderForm();
		var form = this;

		server.validateItemEntry(this.fields.itemid.val(), headerForm.fields.custid.val(), headerForm.fields.shiptoid.val(), function(response) {
			var server = new EqoRequests();
			var form   = new AddItemForm();

			form.fields.itemid.addClass('is-valid');

			if (response.exists) {
				form.fields.itemid.addClass('is-valid');
				form.populateItemInfo();
			} else if (response.matches.itm > 0) {
				var q = form.fields.itemid.val();
				form.fields.itemid.val('');
				var url = URI(form.fields.itemid.closest('.input-group').find('button').data('lookupurl'));
				url.addQuery('q', q);
				var modal_ajax = $('#ajax-modal');
				modal_ajax.find('.modal-title').text('Searching for ' + q);
				modal_ajax.resizeModal('xl');
				modal_ajax.modal('show');
				modal_ajax.find('.modal-body').loadin(url.toString(), function() {});
			} else {
				var alerts = EqoAlerts();
				alerts.notFound(formfields.itemid.val(), function(useAdvancedSearch) {
					if (useAdvancedSearch === true) {
						var url = URI('');
						url.setQuery('q', form.fields.itemid.val());
						window.location.replace(url.toString());
					}
				});
			}
		});
	},
	this.populateItemInfo = function() {
		var server = new EqoRequests();
		server.itmItem(this.fields.itemid.val(), function(item) {
			if (item) {
				$('small.desc1').text(item.description);
				$('small.desc2').text(item.description2);
			}
		});
	}
}

function EqoRequests() {
	this.validateItem = function(itemID, callback) {
		var ajax = new AjaxRequest('{{ page.jsonApiUrl('inv/validate/item/') }}');
		ajax.setData({itemID: itemID});
		ajax.request(function(response) {
			callback(response)
		});
	},
	this.validateItemEntry = function(itemID, custID, shiptoID, callback) {
		var ajax = new AjaxRequest('{{ page.jsonApiUrl('item-lookup') }}');
		ajax.setData({itemID: itemID, custID: custID, shiptoID: shiptoID});
		ajax.request(function(response) {
			callback(response)
		});
	},
	this.itmItem = function(itemID, callback) {
		var ajax = new AjaxRequest('{{ page.jsonApiUrl('inv/item/') }}');
		ajax.setData({itemID: itemID});
		ajax.request(function(response) {
			callback(response)
		});
	}
}

function EqoAlerts() {
	this.notFound = function(itemID, callback) {
		swal2.fire({
			title: 'Item not found.',
			text: itemID + ' cannot be found.',
			icon: 'warning',
			showCancelButton: true,
			confirmButtonText: 'Make advanced search?',
			cancelButtonText: 'No',
		}).then(function(result) {
			if (result.value) {
				callback(result.value);
			}
			callback(false);
		});
	}
}
